---
title: Configuring Secondary Indexes
project: riak
version: 1.4.2+
document: tutorials
toc: true
audience: advanced
keywords: [operator, 2i]
---

## 设置

可以设置 Riak 在 [[LevelDB]] 或 [[Memory]] 后台（或者结合在一起的 [[Multi]] 后台）
中使用二级索引（2i）。

集群中的所有节点都要使用兼容索引的后台，二级缓冲才能正常运行。

### 迁移现有集群

**警告：**迁移时要小心避免让集群负载过重。迁移时要把某些节点上的数据迁移到集群中的其他节点
上，因此会使用比正常情况下更多的网络和硬盘 IO。

下面的步骤可以从集群中删除节点，启用支持 2i 的后台，然后再加入集群。

1. 选择集群中的一个节点，在其中执行 `riak-admin leave` 命令
2. 等待转移完成，然后执行 `riak stop` 命令
3. 设置相应的后台使用 2i
4. 执行 `riak-admin join` 命令
5. 在其他节点中重复上述步骤

## 索引对象

索引对象时，程序会标记一个或多个键值对，形成索引条目。写入时，对象的索引都在这些条目中。
应用程序如果要修改索引，可以先读出对象，添加或删除索引条目，然后再写入对象。如果对象被
删除了，会从所有索引条目中移除。

对象的值和索引应该被认为是一个整体。不可能直接修改索引而不改变对象的值，反过来也不行。你可以
换种方式来理解，每次写入对象时，原有的对象的索引会被删除，然后重新对索引条目提供的集合进行索引。

对于有兄弟数据的对象来说，对象会在索引条目下得所有兄弟数据进行索引。如果能解决冲突，这个过程
就和更新索引一样。Riak 会根据提供的索引条目删除对象的索引，然后再重新索引解决了冲突的对象。

索引是原子的，写入对象时实时更新。也就是说，只要写入操作完成了，对象就会出现在未来的索引查询中。

### 索引数据类型

从 Riak 1.0 开始，Riak 支持两种索引类型，二进制和整数形式。索引没有模式（schema），其类型
编码在索引字段名的后缀中。可用的后缀有 `_int` 和 `_bin`，说明是整形还是字符串（也就是二进制）。
例如，`timestamp_int` 是整形字段，而 `email_bin` 则是字符串字段。

对于更复杂的数据类型（例如日期和时间戳），可以把日期编码成一个字符串，并且选择一个可以正确
排序的格式。例如，日期可以编码成字符串“YYYYMMDD”。浮点数的编码需要选择一个精度等级，然后
乘于一个合适的值，将其变成整数。例如，要存储一个浮点数，其精度为保留到小数点后三位数，那么
就要乘于 1000。

索引字段的名字会自动转换成小写字母形式。索引字段的值应该只包含 ASCII 字符。鉴于这些要求，
在把用户提供的值作为索引来使用时，最好先进行编码。二级索引虽然支持多字节编码，但不应该使用，
因为二级索引的范围查询只能处理单字节字符，如果查询多字节字符串则会返回错误结果。

使用 HTTP 接口时，具有多个值的索引可以通过将值用逗号分开来指定。所以，应用程序要避免使用
逗号作为索引的值。

### 索引大小

对象索引的大小也会计入对象的实际大小上。单个对象的索引数量只受 Riak 推荐使用的对象最大值
限制（不大于 10MB）。Basho 做个压力测试，成功保存了有 1000 个索引条目的对象，但大多数
应用程序应该使用更小的索引数量。

单个索引的大小只受资源大小的限制，但要注意，某些 HTTP 代理会在 HTTP 报头中限制大小。
因为使用 HTTP 接口时，索引是编码在报头中的，这就有可能影响到索引值的大小。

在硬盘中，索引会增加对象的大小，也会保存在另外一个单独的结构中，占用额外的空间。不过每个索引
占用的空间很小。LevelDB 可以进行前缀压缩，这样还能近一步减少索引占用的空间大小。

### 对象的索引和值是正交的

对象的索引和对象的值是完全正交的。索引可能也不可能会重现对象中已经存在的信息。

这种设计有一个用途，应用程序可以把一些信息，例如 JSON 数据，存储在 Riak 对象中，然后使用
索引注解这个对象便于以后读取。索引可以，也可以不重现 JSON 对象中已经保存的数据。例如，对象
可以有一个 `email_bin` 索引字段，而且在 JSON 中有 `email` 字段。

数据重复看起来效率会很低，但可以达到某种效果。例如，应用程序可以把图片（或 MP3 等不开放
无法扩展的数据结构）存储在 Riak 中，使用图片的所有者、文件大小、创建时间等进行索引。

## 索引查询

索引查询一次只能查询一个字段。查询可以取回完全匹配的值，或者一个范围内的值。范围查询包含
起始值。查询操作会返回一系列匹配的键。然后应用程序遍历每个键，查找所需的值。

目前还无法指定返回结果的派讯，而且无法直接使用二级缓存返回一系列对象。未来可能有所改变。

索引查询可以输入 MapReduce 作业，允许应用程序在集群中并行对查询结果进行排序、过滤等操作。

### 查询的性能

2i 使用基于文档的分区，对象的索引和对象本身存储在同一个分区中。这种处理方式会影响查询时的
性能。发起查询时，系统必须从一系列被覆盖的分区中读取数据。系统会检查存储了多少个数据副本，
决定取回完整结果必须要检查的分区数量，计算离线节点的数量。

默认情况下。Riak 会为所有对象保存 3 个副本，所以系统从 3 个系统分区中的一个分区就可以读取
完整的结果，只要选择的分区是正确的。然后查询会向选中的分区广播，读取索引数据，生成键列表，
将其返回给发起请求的节点。

### 特殊字段

启用 2i 后会为每个对象生成一个特殊的字段，`$key` 字段，其值是对象的键，所以应用程序可以
使用这个键在 bucket 中执行范围查询。

还有一个为每个对象自动生成的索引字段是 `$bucket`，其值是对象所属的 bucket，所以应用程序
可以通过二级索引取回 bucket 中的所有对象。
