---
title: Adding and Removing Nodes
project: riak
version: 1.4.2+
document: cookbook
toc: true
audience: intermediate
keywords: [operator]
---

本文讲解如何在 Riak 集群中添加和删除节点。我们会介绍如何合并节点组成集群，以及添加
或删除节点时会发生什么。

## 前提条件

对大多数操作来说都要访问设置文件，其位置根据安装的方式和所用操作系统而有所不同。
具体的位置请参看 [[Configuration Files]] 。

## 创建第一个节点

不管使用安装包安装或者从源码编译安装，安装 Riak 之后都要做一些初始化设置，具体设置的项目因
网络和安全设置而异。

现在节点应该没有运行。如果已经运行，请使用 [[`riak stop` 命令|riak Command Line#stop]]
将其停止。在启动之前，需要做一些修改。如果新创建的节点在修改下述设置之前已经运行了，最好先
删除环文件夹，只需删除 Riak 数据文件夹中的 `ring/` 文件夹即可。一般来说，创建新节点时都要
做下面的设置。

## 修改节点名字

节点的名字对 Erlang VM 来说很重要，特别是要搭建一个集群，节点的名字会标识 Erlang 应用
程序，并且作为网络中的主机名。Riak 集群中的节点都要设定名字，这样才能和其他节点通讯和协调。

节点的名字在 `vm.args` 文件中设置。请修改下面这行代码，
默认的名字是 127.0.0.1，也称作 localhost：

```erlang
-name riak@127.0.0.1
```

将其修改为 IP 地址，或者可解析的主机名，如下所示：

```erlang
-name riak@192.168.1.10
```

## 修改 HTTP 和 Protocol Buffers 绑定地址

默认情况下，Riak 的 HTTP 和 Protocol Buffers 服务绑定到本地地址上，例如 127.0.0.1，因此
无法服务于网外的请求。相应的设置在 [`app.config`|Configuration Files#app.config]] 文件
中，`riak_core` 区之下：

```erlang
{http, [ {"127.0.0.1", 8098 } ]},
```

请将其修改为服务器某个网络接口对应的 IP 地址，或者修改为 0.0.0. 运行访问所有的接口和网络：

```erlang
{http, [ {"0.0.0.0", 8098 } ]},
```

如果要使用 Protocol Buffers，也要做类似设置。按照上面的方式修改 `riak_kv` 区的这行：

```erlang
{pb_ip,   "127.0.0.1" },
```

## 启动节点

和初始化一样，这一步也要在集群中的每个节点中都执行。在加入集群之前，要先启动节点。根据所
使用的安装方式，请使用 Riak 安装包创建的 init 脚本，或者直接调用 `riak` 命令：

```bash
/etc/init.d/riak start
```

或者

```bash
bin/riak start
```

## 启动节点时发生了什么？

启动节点时，会寻找数据文件夹中的集群描述，也就是“环文件”。如果该文件不存在，就会根据所设置
的 `ring_creation_size 创建一个新环描述，并做好分区。然后，节点就可以接收请求了。

## 把节点添加到现有集群

节点启动后就可以加入集群了。（注意，这一步不需要在创建第一个节点时执行，只需在后续节点
中执行。）在现有集群中随便选一个节点，在其中执行 `riak-admin cluster join` 命令，请求
把新节点加入集群。下面的示例中使用了 IP 地址 192.168.2.2 上的节点，这个节点称为
“种子节点”（seed node），把集群中的数据传入新节点。

```bash
riak-admin cluster join riak@192.168.2.2
```

上述命令会输出如下信息：

```
Success: staged join request for 'riak@192.168.2.5' to 'riak@192.168.2.2'
```

要加入集群的所有节点都要执行上述操作。

## 把节点合并组成集群

合并节点组成集群要好几步，包括暂存要合并的节点，审查集群计划和提交变动。

执行 `riak-admin cluster join` 命令暂存要合并的节点后，要审查提议的计划，这一步要
执行 `riak-admin cluster plan` 命令，其输出如下：

```
=============================== Staged Changes ================================
Action         Nodes(s)
-------------------------------------------------------------------------------
join           'riak@192.168.2.2'
join           'riak@192.168.2.2'
join           'riak@192.168.2.2'
join           'riak@192.168.2.2'
-------------------------------------------------------------------------------


NOTE: Applying these changes will result in 1 cluster transition

###############################################################################
                         After cluster transition 1/1
###############################################################################

================================= Membership ==================================
Status     Ring    Pending    Node
-------------------------------------------------------------------------------
valid     100.0%     20.3%    'riak@192.168.2.2'
valid       0.0%     20.3%    'riak@192.168.2.3'
valid       0.0%     20.3%    'riak@192.168.2.4'
valid       0.0%     20.3%    'riak@192.168.2.5'
valid       0.0%     18.8%    'riak@192.168.2.6'
-------------------------------------------------------------------------------
Valid:5 / Leaving:0 / Exiting:0 / Joining:0 / Down:0

Transfers resulting from cluster changes: 51
  12 transfers from 'riak@192.168.2.2' to 'riak@192.168.2.3'
  13 transfers from 'riak@192.168.2.2' to 'riak@192.168.2.4'
  13 transfers from 'riak@192.168.2.2' to 'riak@192.168.2.5'
  13 transfers from 'riak@192.168.2.2' to 'riak@192.168.2.6'
```

如果满意这个计划，就可以执行 `riak-admin cluster commit` 命令提交这次变动。

## 合并节点的过程

节点发出合并请求时，会要求种子节点报告集群的状态。收到集群状态时，节点会将其自身的状态销毁，
换用刚收到的状态。然后节点开始声明分区，只到分区均匀分布，然后检查 N 值，让集群中的分区达到
最优物理分布。

声明分区时，新节点会一直更新集群的状态，只到分区均匀分布为止。声明分区的意思是，对这个特定
分区来说，这个新节点就是主要的副本。

节点重新计算集群的状态后，会广播到集群中的一个随机节点，让其他节点知道新状态。

确认所有负责的 vnode 已经启动后（vnode 映射到 Erlang 进程上），开始进行分区移交，把现有
节点上的数据传输到新节点上。移交操作是在现有节点收到集群的新状态后执行的，因为这时节点上
的 vnode 才发现它们不再是特定分区的主要副本了，所以要把所有的数据传输到新加入的节点这个主要
副本中。

上述过程会在广播集群状态的几分钟内异步执行。还记得吗，声明分区后新节点会对集群内一个随机的
节点广播状态，然后再广播到其他节点，这个过程要花费几分钟，完成后才能进行移交。

移交时，集群的新状态已经传遍了整个集群，所以会存在这样的时间段，移交还在进行，但节点已经开始
接受请求了。Basho 正在努力改善这个问题，但一般来说，和 Riak 交互的应用程序期望处理并不是
所有副本中都有数据的情况。关于这种情况更详细的说明请阅读“[[最终一致性|Eventual Consistency]]”。

<div class ="info">
Ryan Zezeski 写了一篇[[很不错的文章|https://github.com/rzezeski/try-try-try/tree/master/2011/riak-core-the-vnode]]，
讲解了 vnode 声明中期内所发生的事情，还说明了移交操作的不同状态。
</div>

## 从集群中删除节点

从集群中删除节点有两种方法。一种方法假定节点已经退役，例如，因为容量增加而不需要这个节点了，
或者被新节点取代了。另一种方法和失效有关，不是损坏就是无法复原了，所以必须在其他节点上
将其从集群中删除。

删除正在运行的节点使用 `riak-admin cluster leave` 命令。这个命令要在想删除的节点中执行。

跟合并节点类似，执行完 `riak-admin cluster leave` 命令后，还要
审查 `riak-admin cluster plan` 命令的计划，然后使用 `riak-admin cluster commit` 命令
提交变动。

<div class="info">
<div class="title">Riak 1.2 集群管理</div>

请认真学习一下 Riak 1.2 中新加入的 [[cluster 命令|riak-admin Command Line#cluster]]。

</div>

还可以使用 `riak-admin cluster leave <node>` 命令，其中 `<node>` 是 Erlang 的节点名字，
即在 `vm.args` 文件中设定地名字，例如：

```bash
riak-admin cluster leave riak@192.168.2.1
```

这个命令可以在集群中其他任何一个中执行。

这两个命令背后执行的操作是一样的。`riak-admin cluster leave <node>` 命令会自动为你选择
当前节点。

和 `riak-admin cluster leave` 命令一样，也要审查 `riak-admin cluster plan` 给出的计划，
并使用 `riak-admin cluster commit` 命令提交变动，然后变动才会生效。

## 删除节点时发生了什么？

删除节点基本上与合并节点的操作是相反的。不过删除节点时不用声明分区，而是生成一个新集群状态，
找出该节点拥有的所有分区，在剩下的节点中重新均匀的分发。

新状态会广播到集群中所有的节点，而不再是一个随机节点，所以集群立即就知道有节点删除了。
然后在删除的节点中设置集群状态，开始移交，这个操作还是由不再作为主要副本的 vnode 发起，
把数据传输到新拥有者那里。

移交完所有数据后，Erlang VM 进程就会彻底退出。

如果你在其他节点中执行 `riak-admin remove` 命令，上述操作就会在该节点中进行。最后一步，
移交旧节点的数据可定是会失败的，因为删除的节点已经不存在了。不过集群还是会给出足够的副本，
即便没有被删除的节点了，还是能自我平衡。
