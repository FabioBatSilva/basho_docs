---
title: Riak 扩放和操作最佳实践
project: riak
version: 1.4.2+
document: cookbook
toc: true
audience: intermediate
keywords: [operator, best-practices]
---

## 硬盘容量

把硬盘装满数据可不是个好主意，遇到下列情况时就要增加容量了：

 - 硬盘空间使用量超过 80%
 - 按照当前的增速，容量不够 10 天使用

## RAID 等级

Riak 通过内建的冗余提供了数据恢复能力。

 - RAID0 可用来提升性能，但要随时一整个节点的可用性
 - RAID5/6 可用了提升硬 RAID0 损失的可用性，而且还比单个硬盘的性能要高
 - 你应该选择一个自己觉得合用的 RAID 等级（或者不用 RAID）

## 要预留多少硬盘空间

 - 添加新节点会立即增加集群的总容量，但要留有足够的内网容量，这样移交现有数据的速度才会超过新进数据
 - 一旦达到了特定的比例，新进数据量远小于集群的总容量，就可以在需要时添加新的节点
 - 我们建议预留一到两周的时间，如果预计会用完所有容量，还有足够的时间添加节点，在容量用完之前做好移交处理
 - 对大型存储来说，用完 80% 容量时就要谨慎考虑增加容量了

## 要预留多少 CPU 容量

 - 在稳定的状态下，除掉其他进程，CPU 利用率的峰值要小于 30%
 - 这样就用足够的空间运行其他进程，例如备份和移交

## 要预留多少网络容量

 - 网络流量突发性很强，和很多因素有关，变化也快
 - 常规负载时，10 分钟内的平均值要小于最大容量的 20%
 - Riak 会产生 3-5 倍的节点内部流量，称之为入站流量，在设计时要考虑这一点

## 什么时候添加节点

*遇到下列情况时要添加更多的节点：*

 - 使用了 80% 的存储容量
 - 距填满集群还有不到 10 天
 - 当前节点的 IO/CPU 使用率比某段时间内的平均值高，特别是使用 Map/Reduce 操作时
 - 如果不想添加节点还可以增加现有节点的存储容量
   - 只有明确网络和 CPU 容量还有结余时，才应该扩容现有节点
   - Riak 中的节点地位是相等的。不允许只为某些节点扩容，事实上，如果没有为所有节点扩容，添加容量是不起作用的

## 如何添加节点

 - 应该一次性添加所需的节点
 - 如果要添加多个节点，不要一次只加一个
 - 可以限制传输率，把优先权给到访客的流量

## 扩放

 - 所有大型系统的扩放都要舍弃某些资源的可用性
 - 稳健起见，繁忙的 Riak 集群应该放置在：
   - 新网络连接限制了：
   - 现有的网络连接消耗了大多数网络带宽
   - CPU 使用率 < 30%
   - 硬盘 IO 使用率 < 90%
 - 可以使用 HAProxy，或应用程序服务器，限制新网络连接，把网络和 IO 使用率限制在 90% 以下，CPU 使用率则要小于 30%
