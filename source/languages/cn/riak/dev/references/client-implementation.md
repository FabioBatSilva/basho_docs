---
title: 客户端开发指南
project: riak
version: 1.4.2+
document: tutorials
toc: true
audience: advanced
keywords: [interface, client]
---

本文详细介绍了 Riak 客户端接口，可以作为理解客户端和 Riak 交互方式的指南，也可以了解如何实现客户端代码库或应用程序。下面几部分介绍优秀客户端应该具有的特点。

## 隐藏传输细节

虽然 Riak 提供的两种接口实现的功能不完全一样，但客户端应该尽量对应用程序隐藏接口的实现细节，提供唯一的接口。这样如果在操作中要在两种接口直接切换，就无需修改太多的代码。

## 请求重试

我们在“[[最终一致性]]”一文中说过，很多情况下返回的结果会出现临时的不一致，导致获取的数据过期或者是兄弟数据。为了应对这种情况，客户端在报告操作失败之前应该重新发送几次请求。例如，如果要读取的键对应的数据不同的副本出现不一致，那么多试几次就可以通过[[读取修复|副本#Read-Repair]]更新过期的副本。如果客户端和 Riak 节点之间的链接莫名其妙的终端了，重新发送请求还可以尝试重新建立连接。Riak 中的很多操作都是幂等的，因此再次执行也不会产生副作用。

<a id="Sibling-Resolution"></a>
## 处理兄弟数据

为了能让应用程序有机会处理有冲突的数据，或者部分写入的数据，可以对 Riak 做些设置，给客户端提供数据的多个版本，或者称为“[[兄弟数据|向量时钟#Siblings]]”。然后，应用程序根据需求处理所得的兄弟数据。客户端应该提供一种解决方案，检测到兄弟数据时自动执行，在某些读取或存储操作还有可能多次执行。如果不处理兄弟数据，存储的对象版本数量会持续增长，最终导致集群性能下降，出现较高的操作迟延或完全没反应。

## 写前读取和向量时钟

只要读取请求的返回结果不是“not found”，Riak 就会随着结果一起返回一个编码的“[[向量时钟]]”。向量时钟告诉 Riak 如何处理并发写入，提供客户端最后修改的对象版本。为了避免[[兄弟数据激增|向量时钟#Sibling]]，客户端在更新对象时一定要使用向量时钟。所以，在写入对象之前一定要先把对象读出来（除非 Riak 选择了键，或者知道键是新的）。客户端自动进行写前读取可以避免兄弟数据激增，从而减少问题的出现。客户端还可以选择实现在读取数据时自动[[处理兄弟数据|客户端开发指南#Sibling-Resolution]]。

## 不建议执行耗资源的操作

很多操作虽然有用，但在生产环境中执行是很耗资源的，例如 [[HTTP 的列键操作|通过 HTTP 列出键]]。优秀的客户端应该实现全部功能，但当执行耗资源的操作时要给出提醒。

## Nagle 算法

大多数情况下，特别是使用消息比较小的 [[PBC API]] 时，客户端应该在和 Riak 的 socket 连接上指定 `TCP_NODELAY` 旗标，禁用 [Nagle 算法](http://en.wikipedia.org/wiki/Nagle%27s_algorithm)。如果测评中发现至少 40 毫秒的迟延，就说明连接的其中一端启用了 Nagle 算法。如果客户端程序和 Riak 集群之间有较高的环游迟延，禁用 Nagle 算法的效果不太，但对于连接良好的客户端就能很大程度的降低迟延。
