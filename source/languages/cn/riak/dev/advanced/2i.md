---
title: 二级索引高级用法
project: riak
version: 1.4.2+
document: guide
toc: true
audience: advanced
keywords: [developers, 2i]
---

## 工作原理

二级索引使用基于文档的分区，也称为本地索引，索引都存在各文档中，在本地虚拟节点上。二级索引是一系列键值对，和 HTTP 报头相似。写入时会使用包含键值对元数据给对象打上标签。可以用这些元数据来查询匹配的键。

![Secondary Index](/images/Secondary-index-example.png)

索引存在于多个设备上，查询时会涉及多个虚拟节点，而且要合并查询结果。索引和对象都存放在同一个分区中，所以查询时可能出现性能问题。查询时，系统必须从一系列分区中读取数据。系统要查看数据有多少副本（n 值），然后决定最少要检查多少分区（1/n）才能取回完整的结果，下线的节点要在检查范围之内。

应用程序可以修改索引，先把对象读出来，添加或删除索引，然后再写入对象。数据删除后其对应的所有索引都会被自动删除。对象的值和索引应该看成是一个整体，没修改值是无法修改索引的，相反亦然。索引是原子的，写入对象时实时更新。这就意味着，写入操作完成后立即就可以查询索引。

Riak 默认为所有对象存储 3 个副本，只要选择了正确的分区集合就能从系统分区的 1/3 中生成完成的结果。查询会在每个分区上执行，读取索引数据，然后把生成的键列表返回给发起请求的节点。

<!-- ## 2i and MapReduce -->
